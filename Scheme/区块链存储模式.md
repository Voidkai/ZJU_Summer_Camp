# 区块链存储模式



## 分布式存储

### 架构分类

1. 有中心管理节点
2. 无中心管理节点



### 需要解决的问题

- 数据寻址：查询数据存在什么地方
- 数据的存储：数据读写
- 数据的安全性：数据的冗余备份，通常有 EC（类似 raid，数据恢复的时候对 CPU 有一定的要求） 方式和多副本的方式
- 数据一致性：多副本的冗余需要保证多副本的一致性
- 系统性能：应对大规模的数据存储和读取需求

## 区块链存储结构

1. 区块
2. 节点（账户）

##  区块链存储模式

基于区块链的存储系统，会为存储准备数据，然后通过一个去中心化的基础架构进行分发，这个过程可以分为以下六个步骤：

1. **创建数据分片** 。存储系统将数据分成更小的片段，这个过程称为分片(Sharding)。这一步将数据分解为可管理的块，这些块可以分布在多个节点上。具体的分片方法取决于数据类型和进行分片的应用程序，对关系数据库进行分片。
2. **加密每个分片。** 分片之后，存储系统需要加密本地系统上的每个数据分片。内容所有者可以完全控制此过程。目标是确保内容所有者以外的任何人都无法查看/访问分片中的数据，无论数据位于何处、该数据是静态还是动态。
3. **为每个分片生成哈希(Hash)。** 区块链存储系统根据分片的数据或加密密钥生成唯一的哈希——即固定长度的加密输出字符串。哈希将添加到分类帐和分片元数据，以便将事务链接到存储的分片。生成哈希的确切方法因系统而异。
4. **复制每个分片。** 存储系统会复制每个分片，因此有足够的冗余副本，可确保可用性和性能，并防止性能下降和数据丢失。由内容所有者来决定每个分片的副本数量以及这些分片所在的位置。此过程中，内容所有者应该为需要维护的最小副本数建立阈值，以确保不会丢失数据。
5. **分发复制的分片。** P2P网络将复制的分片分发到地理上分散的存储节点，无论是区域还是全局。多个组织或个人(有时也称作farmer)拥有存储节点，通过租用额外的存储空间可换取某种类型的补偿，通常是加密货币。没有一个实体能够拥有所有存储资源，或者控制存储基础架构。只有内容所有者才能完全访问其所有数据，无论这些节点位于何处。
6.  **将交易记录到分类帐。** 存储系统记录区块链分类帐中的所有事务，并在所有节点之间同步该信息。分类帐存储与事务相关的详细信息，例如分片位置，分片哈希和租赁成本等等。由于分类帐基于区块链技术，因此它具有透明性、可验证性、可追溯性以及防篡改性。



当存储过程首次启用时，可能最初会在区块链分类帐中记录事务。然后，会使用信息(例如唯一哈希或特定于节点的详细信息)来更新事务，因为它们已经是可用的。接着，在参与节点对事务进行了验证之后，系统会将事务标记为分类帐中的最终事务并进行锁定，以防止篡改。





# 引言

结合纠删码以及局部修复码技术，提出一种基于纠删码的区块链系统区块文件存储模型



# 区块链系统

区块链各节点之间具备开放互联的基本特点，基于P2P 技术使得每个节点平等获得数据并输出数
据，无需任何中心化机构的审核。每个区块链节点有完整的副本数据，拥有独立的数据审计能力。所有处于同一区块链网络中的节点都遵循共识协议，计算并存储相同的数据，在整个区块链网络少量数据节点失效或者接收到错误数据的情况下，节点依然拥有数据校验及审计能力。

# 基于纠删码的超级账本区块文件存储模型

区块链节点将其保存的完整区块文件通过纠删码技术编码成多个编码块，每个节点仅保留部分编码块，全网节点拥有完整的编码块信息，使得全网中各个节点在尽可能减少存储空间占用的同时，又能保证原始区块文件不丢失。

## 编码存储过程

本文采用一种基于通信的方案，在超级账本区块链网络搭建完成初期产生第一个区块文件之前，
排序服务集群会确认加入网络的组织的先后顺序，当有新的组织加入该网络或者退出该网络时，排序服务集群都会定期向其余组织的背书节点广播编码控制信息，包括用于指示切分区块文件的原始块数量、纠删码编码算法、编码容错率、节点数量以及编码块组号与节点的对应关系。

1. 第一个区块文件完成后，所有记账节点将根据最近一次接收到的编码控制信息对区块文件进行纠删码编码存储。

纠删码容错率$\lambda$，原始文件切分为$k$个数据块 ，$r = k \frac{\lambda}{1-\lambda}$个校验块，$t$个节点(组织)分发$(k + r) = k\frac{1}{1-\lambda}$编码块。

每个节点保存$\frac{k+r}{t} = \frac{k}{(1-\lambda)t}$个编码块的数量, 由编码控制信息确定保存第$i$组编码块。

## 解码恢复过程

